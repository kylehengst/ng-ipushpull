(function(){"use strict";function a(){}function b(a,b){for(var c=a.length;c--;)if(a[c].listener===b)return c;return-1}function c(a){return function(){return this[a].apply(this,arguments)}}var d=a.prototype,e=this,f=e.EventEmitter;d.getListeners=function(a){var b,c,d=this._getEvents();if(a instanceof RegExp){b={};for(c in d)d.hasOwnProperty(c)&&a.test(c)&&(b[c]=d[c])}else b=d[a]||(d[a]=[]);return b},d.flattenListeners=function(a){var b,c=[];for(b=0;b<a.length;b+=1)c.push(a[b].listener);return c},d.getListenersAsObject=function(a){var b,c=this.getListeners(a);return c instanceof Array&&(b={},b[a]=c),b||c},d.addListener=function(a,c){var d,e=this.getListenersAsObject(a),f="object"==typeof c;for(d in e)e.hasOwnProperty(d)&&-1===b(e[d],c)&&e[d].push(f?c:{listener:c,once:!1});return this},d.on=c("addListener"),d.addOnceListener=function(a,b){return this.addListener(a,{listener:b,once:!0})},d.once=c("addOnceListener"),d.defineEvent=function(a){return this.getListeners(a),this},d.defineEvents=function(a){for(var b=0;b<a.length;b+=1)this.defineEvent(a[b]);return this},d.removeListener=function(a,c){var d,e,f=this.getListenersAsObject(a);for(e in f)f.hasOwnProperty(e)&&(d=b(f[e],c),-1!==d&&f[e].splice(d,1));return this},d.off=c("removeListener"),d.addListeners=function(a,b){return this.manipulateListeners(!1,a,b)},d.removeListeners=function(a,b){return this.manipulateListeners(!0,a,b)},d.manipulateListeners=function(a,b,c){var d,e,f=a?this.removeListener:this.addListener,g=a?this.removeListeners:this.addListeners;if("object"!=typeof b||b instanceof RegExp)for(d=c.length;d--;)f.call(this,b,c[d]);else for(d in b)b.hasOwnProperty(d)&&(e=b[d])&&("function"==typeof e?f.call(this,d,e):g.call(this,d,e));return this},d.removeEvent=function(a){var b,c=typeof a,d=this._getEvents();if("string"===c)delete d[a];else if(a instanceof RegExp)for(b in d)d.hasOwnProperty(b)&&a.test(b)&&delete d[b];else delete this._events;return this},d.removeAllListeners=c("removeEvent"),d.emitEvent=function(a,b){var c,d,e,f,g,h=this.getListenersAsObject(a);for(f in h)if(h.hasOwnProperty(f))for(c=h[f].slice(0),e=0;e<c.length;e++)d=c[e],d.once===!0&&this.removeListener(a,d.listener),g=d.listener.apply(this,b||[]),g===this._getOnceReturnValue()&&this.removeListener(a,d.listener);return this},d.trigger=c("emitEvent"),d.emit=function(a){var b=Array.prototype.slice.call(arguments,1);return this.emitEvent(a,b)},d.setOnceReturnValue=function(a){return this._onceReturnValue=a,this},d._getOnceReturnValue=function(){return!this.hasOwnProperty("_onceReturnValue")||this._onceReturnValue},d._getEvents=function(){return this._events||(this._events={})},a.noConflict=function(){return e.EventEmitter=f,a},"function"==typeof define&&define.amd?define(function(){return a}):"object"==typeof module&&module.exports?module.exports=a:e.EventEmitter=a}).call(this);var ipushpull;!function(a){"use strict";a.module=angular.module("ipushpull",[])}(ipushpull||(ipushpull={}));var ipushpull;!function(a){"use strict";var b=function(){function a(a,b){this._headers={},this._cache=!1,this._overrideLock=!1,this._method=a,this._url=b,this._headers={"Content-Type":"application/json","x-requested-with":"XMLHttpRequest","x-ipp-device-uuid":"","x-ipp-client":"","x-ipp-client-version":""}}return a.get=function(b){return new a("GET",b)},a.post=function(b){return new a("POST",b)},a.put=function(b){return new a("PUT",b)},a.del=function(b){return new a("DELETE",b)},Object.defineProperty(a.prototype,"METHOD",{get:function(){return this._method},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"URL",{get:function(){return this._url},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"HEADERS",{get:function(){return this._headers},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"DATA",{get:function(){return this._data},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"PARAMS",{get:function(){return this._params},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"CACHE",{get:function(){return this._cache},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"OVERRIDE_LOCK",{get:function(){return this._overrideLock},enumerable:!0,configurable:!0}),a.prototype.method=function(a){return this._method=a,this},a.prototype.url=function(a){return this._url=a,this},a.prototype.headers=function(a,b){return void 0===b&&(b=!1),this._headers=b?a:angular.merge({},this._headers,a),this},a.prototype.data=function(a){return this._data=a,this},a.prototype.params=function(a,b){return void 0===b&&(b=!1),this._params=b?a:angular.merge({},this._params,a),this},a.prototype.cache=function(a){return a&&"GET"===this._method&&(this._cache=a),this},a.prototype.overrideLock=function(a){return void 0===a&&(a=!0),this._overrideLock=a,this},a}(),c=function(){function a(a,b,c,d,e,f){var g=this;this.$http=a,this.$httpParamSerializerJQLike=b,this.$q=c,this.$injector=d,this.storage=e,this.config=f,this._locked=!1,this.dummyRequest=function(a){var b=g.$q.defer();return b.reject({data:{},status:666,statusText:"Api is locked",config:a}),b.promise},this.handleSuccess=function(a){var b=g.$q.defer();return b.resolve({success:!0,data:a.data,httpCode:parseInt(a.status,10),httpText:a.statusText}),b.promise},this.handleError=function(a){var b=g.$q.defer();if(401===parseInt(a.status,10)&&!g._locked&&"invalid_grant"!==a.data.error){var c=g.$injector.get("ippAuthService");c.emit(c.EVENT_401)}return b.reject({success:!1,data:a.data,httpCode:parseInt(a.status,10),httpText:a.statusText}),b.promise},this._endPoint=this.config.url+"/api/1.0/"}return a.prototype.parseError=function(a,b){var c=b;if(a.data){var d=Object.keys(a.data);c=d.length?angular.isArray(a.data[d[0]])?a.data[d[0]][0]:"string"==typeof a.data[d[0]]?a.data[d[0]]:b:b}else c=b;return c},a.prototype.block=function(){this._locked=!0},a.prototype.unblock=function(){this._locked=!1},a.prototype.getSelfInfo=function(){return this.send(b.get(this._endPoint+"users/self/").cache(!1).overrideLock())},a.prototype.refreshAccessTokens=function(a){return this.send(b.post(this._endPoint+"oauth/token/").data(this.$httpParamSerializerJQLike({grant_type:"refresh_token",client_id:this.config.api_key,client_secret:this.config.api_secret,refresh_token:a})).headers({"Content-Type":"application/x-www-form-urlencoded"}).overrideLock())},a.prototype.userLogin=function(a){return this.send(b.post(this._endPoint+"oauth/token/").data(this.$httpParamSerializerJQLike({grant_type:"password",client_id:this.config.api_key,client_secret:this.config.api_secret,username:a.email,password:a.password})).headers({"Content-Type":"application/x-www-form-urlencoded"}))},a.prototype.getDomains=function(){return this.send(b.get(this._endPoint+"domains/"))},a.prototype.getDomain=function(a){return this.send(b.get(this._endPoint+"domains/"+a+"/"))},a.prototype.createFolder=function(a){return this.send(b.post(this._endPoint+"domains/").data(a.data))},a.prototype.updateDomain=function(a){return this.send(b.put(this._endPoint+"domains/"+a.domainId+"/").data(a.data))},a.prototype.getDomainPages=function(a){return this.send(b.get(this._endPoint+"domains/"+a+"/page_access/"))},a.prototype.getDomainsAndPages=function(){return this.send(b.get(this._endPoint+"domain_page_access/"))},a.prototype.getPage=function(a){return this.send(b.get(this._endPoint+"domains/id/"+a.domainId+"/page_content/id/"+a.pageId+"/").params({client_seq_no:a.seq_no}))},a.prototype.getPageByName=function(a){return this.send(b.get(this._endPoint+"domains/name/"+a.domainId+"/page_content/name/"+a.pageId+"/").params({client_seq_no:a.seq_no}))},a.prototype.getPageAccess=function(a){return this.send(b.get(this._endPoint+"domains/id/"+a.domainId+"/page_access/id/"+a.pageId+"/"))},a.prototype.createPage=function(a){return this.send(b.post(this._endPoint+"domains/"+a.domainId+"/pages/").data({name:a.data.name}))},a.prototype.savePageContent=function(a){return this.send(b.put(this._endPoint+"domains/id/"+a.domainId+"/page_content/id/"+a.pageId+"/").data(a.data))},a.prototype.savePageContentDelta=function(a){return this.send(b.put(this._endPoint+"domains/id/"+a.domainId+"/page_content_delta/id/"+a.pageId+"/").data(a.data))},a.prototype.savePageSettings=function(a){return this.send(b.put(this._endPoint+"domains/"+a.domainId+"/pages/"+a.pageId+"/").data(a.data))},a.prototype.deletePage=function(a){return this.send(b.del(this._endPoint+"domains/"+a.domainId+"/pages/"+a.pageId+"/"))},a.prototype.saveUserInfo=function(a){return this.send(b.put(this._endPoint+"users/self/").data(a))},a.prototype.changePassword=function(a){return this.send(b.put(this._endPoint+"credentials/self/").data(a))},a.prototype.changeEmail=function(a){return this.send(b.put(this._endPoint+"credentials/self/").data(a))},a.prototype.forgotPassword=function(a){return this.send(b.post(this._endPoint+"password_reset/").data(a))},a.prototype.resetPassword=function(a){return this.send(b.post(this._endPoint+"password_reset/confirm/").data(a))},a.prototype.inviteUsers=function(a){return this.send(b.post(this._endPoint+"domains/"+a.domainId+"/invitations/").data(a.data))},a.prototype.acceptInvitation=function(a){return this.send(b.post(this._endPoint+"users/invitation/confirm/").data(a))},a.prototype.refuseInvitation=function(a){return this.send(b.del(this._endPoint+"users/invitation/confirm/").data(a))},a.prototype.domainInvitations=function(a){return this.send(b.get(this._endPoint+"domains/"+a.domainId+"/invitations/").params({is_complete:"False"}))},a.prototype.userInvitations=function(){return this.send(b.get(this._endPoint+"users/self/invitations/").params({is_complete:"False"}))},a.prototype.domainAccessLog=function(a){return this.send(b.get(this._endPoint+"domain_access/"+a.domainId+"/events/").params({page_size:a.limit}))},a.prototype.domainUsers=function(a){return this.send(b.get(this._endPoint+"domain_access/"+a.domainId+"/users/"))},a.prototype.activateUser=function(a){return this.send(b.post(this._endPoint+"users/signup/confirm/").data(a))},a.prototype.setDomainDefault=function(a){return this.send(b.put(this._endPoint+"domain_access/"+a.domainId+"/users/self/").data(a.data))},a.prototype.resendInvite=function(a){return this.send(b.put(this._endPoint+"domains/"+a.domainId+"/invitations/"+a.inviteId+"/resend/"))},a.prototype.updateDomainAccess=function(a){return this.send(b.put(this._endPoint+"domain_access/"+a.domainId+"/users/").data(a.data))},a.prototype.removeUsersFromDomain=function(a){return this.send(b.del(this._endPoint+"domain_access/"+a.domainId+"/users/").data(a.data))},a.prototype.getInvitation=function(a){return this.send(b.get(this._endPoint+"users/invitations/"+a.token+"/"))},a.prototype.cancelInvitations=function(a){return this.send(b.del(this._endPoint+"domains/"+a.domainId+"/invitations/").data(a.data))},a.prototype.getDomainAccessGroups=function(a){return this.send(b.get(this._endPoint+"domains/"+a.domainId+"/access_groups/"))},a.prototype.getDomainAccessGroup=function(a){return this.send(b.get(this._endPoint+"domains/"+a.domainId+"/access_groups/"+a.groupId+"/"))},a.prototype.addDomainAccessGroup=function(a){return this.send(b.post(this._endPoint+"domains/"+a.domainId+"/access_groups/").data(a.data))},a.prototype.putDomainAgroupMembers=function(a){return this.send(b.post(this._endPoint+"domains/"+a.domainId+"/access_groups/"+a.agroupId+"/members/").data(a.data))},a.prototype.putDomainAgroupPages=function(a){return this.send(b.post(this._endPoint+"domains/"+a.domainId+"/access_groups/"+a.agroupId+"/pages/").data(a.data))},a.prototype.updateDomainAgroup=function(a){return this.send(b.put(this._endPoint+"domains/"+a.domainId+"/access_groups/"+a.agroupId+"/").data(a.data))},a.prototype.deleteDomainAGroup=function(a){return this.send(b.del(this._endPoint+"domains/"+a.domainId+"/access_groups/"+a.agroupId+"/"))},a.prototype.getDomainPageAccess=function(a){return this.send(b.get(this._endPoint+"domain_page_access/"+a.domainId+"/"))},a.prototype.getDomainCustomers=function(a){return this.send(b.get(this._endPoint+"domains/"+a.domainId+"/customers/"))},a.prototype.saveDomainPageAccess=function(a){return this.send(b.put(this._endPoint+"domain_page_access/"+a.domainId+"/basic/").data(a.data))},a.prototype.getTemplates=function(a){return this.send(b.get(this._endPoint+"templates/"))},a.prototype.saveCustomer=function(a){return this.send(b.post(this._endPoint+"domains/"+a.domainId+"/customers/").data(a.data))},a.prototype.updateCustomer=function(a){return this.send(b.put(this._endPoint+"domains/"+a.domainId+"/customers/"+a.data.id+"/").data(a.data))},a.prototype.removeCustomer=function(a){return this.send(b.del(this._endPoint+"domains/"+a.domainId+"/customers/"+a.customerId+"/"))},a.prototype.getDocEmailRules=function(a){return this.send(b.get(this._endPoint+"domains/"+a.domainId+"/docsnames/"))},a.prototype.createDocEmailRule=function(a){return this.send(b.post(this._endPoint+"domains/"+a.domainId+"/docsnames/").data(a.data))},a.prototype.updateDocEmailRule=function(a){return this.send(b.put(this._endPoint+"domains/"+a.domainId+"/docsnames/"+a.docRuleId+"/").data(a.data))},a.prototype.deleteDocEmailRule=function(a){return this.send(b.del(this._endPoint+"domains/"+a.domainId+"/docsnames/"+a.docRuleId+"/"))},a.prototype.send=function(a){var b=this.storage.get("access_token");a.headers({Authorization:"Bearer "+(b?b:"null")});var c=this._locked&&!a.OVERRIDE_LOCK?this.dummyRequest:this.$http;a.cache(!1);var d=c({url:a.URL,cache:a.CACHE,method:a.METHOD,params:a.PARAMS,data:a.DATA,headers:a.HEADERS});return d.then(this.handleSuccess,this.handleError)},a.$inject=["$http","$httpParamSerializerJQLike","$q","$injector","ippGlobalStorageService","ipushpull_conf"],a}();a.module.service("ippApiService",c)}(ipushpull||(ipushpull={}));var __extends=this&&this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);a.prototype=null===b?Object.create(b):(c.prototype=b.prototype,new c)},ipushpull;!function(a){"use strict";var b=function(a){function b(b,c,d,e){var f=this;a.call(this),this.$q=b,this.ippApi=c,this.storage=d,this.config=e,this._user={},this._authenticated=!1,this._authInProgress=!1,this.on401=function(){f.ippApi.block(),f.storage.remove("access_token"),f.emit(f.EVENT_RE_LOGGING),f.authenticate(!0).then(function(){f.emit(f.EVENT_LOGIN_REFRESHED)},function(){f.emit(f.EVENT_ERROR)}).finally(function(){f.ippApi.unblock()})},this.on("401",this.on401)}return __extends(b,a),Object.defineProperty(b.prototype,"EVENT_LOGGED_IN",{get:function(){return"logged_in"},enumerable:!0,configurable:!0}),Object.defineProperty(b.prototype,"EVENT_RE_LOGGING",{get:function(){return"re_logging"},enumerable:!0,configurable:!0}),Object.defineProperty(b.prototype,"EVENT_LOGIN_REFRESHED",{get:function(){return"login_refreshed"},enumerable:!0,configurable:!0}),Object.defineProperty(b.prototype,"EVENT_LOGGED_OUT",{get:function(){return"logged_out"},enumerable:!0,configurable:!0}),Object.defineProperty(b.prototype,"EVENT_ERROR",{get:function(){return"error"},enumerable:!0,configurable:!0}),Object.defineProperty(b.prototype,"EVENT_401",{get:function(){return"401"},enumerable:!0,configurable:!0}),Object.defineProperty(b.prototype,"user",{get:function(){return this._user},enumerable:!0,configurable:!0}),b.prototype.authenticate=function(a){var b=this;void 0===a&&(a=!1);var c=this.$q.defer();return this._authInProgress?(c.reject("Auth already in progress"),c.promise):(this._authInProgress=!0,this._authenticated&&!a?(this._authInProgress=!1,c.resolve(),c.promise):(this.processAuth().then(function(a){b._authenticated||(b._authenticated=!0,b.emit(b.EVENT_LOGGED_IN)),c.resolve()},function(a){b.emit(b.EVENT_ERROR,a),b._authenticated&&b.logout(),c.reject(a)}).finally(function(){b._authInProgress=!1}),c.promise))},b.prototype.login=function(a,b){var c=this,d=this.$q.defer();return this.ippApi.userLogin({grant_type:"password",client_id:this.config.api_key,client_secret:this.config.api_secret,email:a,password:b}).then(function(a){c.saveTokens(a.data),c.authenticate().then(d.resolve,d.reject)},function(a){if(a.message="",400===a.httpCode||401===a.httpCode)switch(a.data.error){case"invalid_grant":a.message="The username and password you entered did not match our records. Please double-check and try again.";break;case"invalid_client":a.message="Your client doesn't have access to iPushPull system.";break;case"invalid_request":a.message=a.data.error_description;break;default:a.message=c.ippApi.parseError(a.data,"Unknown error")}c.emit(c.EVENT_ERROR,a),d.reject(a)}),d.promise},b.prototype.logout=function(){this.storage.remove("access_token"),this.storage.remove("refresh_token"),this._authenticated=!1,this.emit(this.EVENT_LOGGED_OUT)},b.prototype.processAuth=function(){var a=this,b=this.$q.defer(),c=this.storage.get("access_token"),d=this.storage.get("refresh_token");return c?this.getUserInfo():(d?this.refreshTokens().then(function(c){a.saveTokens(c.data),a.getUserInfo().then(b.resolve,b.reject)},function(c){a.storage.remove("refresh_token"),b.reject(c)}):b.reject("No tokens available"),b.promise)},b.prototype.refreshTokens=function(){var a=this.storage.get("refresh_token");return this.ippApi.refreshAccessTokens(a)},b.prototype.saveTokens=function(a){this.storage.create("access_token",a.access_token),this.storage.create("refresh_token",a.refresh_token)},b.prototype.getUserInfo=function(){var a=this,b=this.$q.defer();return this.ippApi.getSelfInfo().then(function(c){a._user=c.data,b.resolve()},b.reject),b.promise},b.$inject=["$q","ippApiService","ippGlobalStorageService","ipushpull_conf"],b}(EventEmitter);a.module.service("ippAuthService",b)}(ipushpull||(ipushpull={}));var ipushpull;!function(a){"use strict";var b=function(){function a(){}return a._instance=function(){return new a},a.prototype.decryptContent=function(a,b){if(this.libCheck()&&b){var c=forge.util.decode64(b),d=c.substring(0,16),e=c.substring(16);e=forge.util.createBuffer(e,"latin1"),d=forge.util.createBuffer(d,"latin1");var f=forge.cipher.createDecipher("AES-CBC",this.hashPassphrase(a.passphrase));f.start({iv:d}),f.update(e);var g;f.finish();try{g=JSON.parse(f.output.toString())}catch(a){g=void 0}return g}},a.prototype.encryptContent=function(a,b){if(this.libCheck()){var c=JSON.stringify(b),d=this.hashPassphrase(a.passphrase),e=forge.random.getBytesSync(16),f=forge.cipher.createCipher("AES-CBC",d);f.start({iv:e}),f.update(forge.util.createBuffer(c,"utf8")),f.finish();var g=f.output,h=forge.util.createBuffer();h.putBytes(e),h.putBytes(g.bytes());var i=h.getBytes();return forge.util.encode64(i)}},a.prototype.hashPassphrase=function(a){var b=forge.md.sha256.create();return b.update(a),b.digest().bytes()},a.prototype.libCheck=function(){return"undefined"==typeof forge,"undefined"!=typeof forge},a}();a.module.factory("ippCryptoService",b._instance)}(ipushpull||(ipushpull={}));var __extends=this&&this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);a.prototype=null===b?Object.create(b):(c.prototype=b.prototype,new c)},ipushpull;!function(a){"use strict"}(ipushpull||(ipushpull={}));var ipushpull;!function(a){"use strict";var b,c,d,e,f,g,h,i,j=function(){function a(a,j,l,m,n,o,p,q){var r={url:"https://www.ipushpull.com"};return b=a,c=j,d=l,e=m,f=n,g=o,h=p,i=angular.merge({},r,q),k}return a.$inject=["$q","$timeout","$interval","ippApiService","ippAuthService","ippGlobalStorageService","ippCryptoService","ipushpull_conf"],a}();a.module.service("ippPageService",j);var k=function(a){function c(b,c){var d=this;a.call(this),this.ready=!1,this.decrypted=!0,this.updatesOn=!0,this._supportsWS=!0,this._encryptionKeyPull={name:"",passphrase:""},this._encryptionKeyPush={name:"",passphrase:""},this._supportsWS="WebSocket"in window||"MozWebSocket"in window,this._folderId=isNaN(+c)?void 0:c,this._pageId=isNaN(+b)?void 0:b,this._folderName=isNaN(+c)?c:void 0,this._pageName=isNaN(+b)?b:void 0,this._pageId||(this.updatesOn=!1),this._pageId?this.init():this.getPageId(this._folderName,this._pageName).then(function(a){d._pageId=a.pageId,d._folderId=a.folderId,d.init()},function(a){})}return __extends(c,a),Object.defineProperty(c.prototype,"TYPE_REGULAR",{get:function(){return 0},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,"TYPE_ALERT",{get:function(){return 5},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,"TYPE_PDF",{get:function(){return 6},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,"TYPE_PAGE_ACCESS_REPORT",{get:function(){return 1001},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,"TYPE_DOMAIN_USAGE_REPORT",{get:function(){return 1002},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,"TYPE_GLOBAL_USAGE_REPORT",{get:function(){return 1003},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,"TYPE_PAGE_UPDATE_REPORT",{get:function(){return 1004},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,"TYPE_LIVE_USAGE_REPORT",{get:function(){return 1007},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,"EVENT_READY",{get:function(){return"ready"},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,"EVENT_DECRYPTED",{get:function(){return"decrypted"},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,"EVENT_NEW_CONTENT",{get:function(){return"new_content"},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,"EVENT_NEW_META",{get:function(){return"new_meta"},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,"EVENT_ACCESS_UPDATED",{get:function(){return"access_updated"},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,"EVENT_ERROR",{get:function(){return"error"},enumerable:!0,configurable:!0}),c.create=function(a,d,f,g){var h=b.defer();if(g){var i=new c(g.id,g.domain_id);i.on(i.EVENT_READY,function(){i.clone(a,d).then(h.resolve,h.reject).finally(function(){i.destroy()})})}else e.createPage({domainId:a,data:{name:d,special_page_type:f}}).then(function(b){var d=new c(b.data.id,a);d.on(d.EVENT_READY,function(){d.stop(),h.resolve(d)})},function(a){h.reject(a)});return h.promise},Object.defineProperty(c.prototype,"encryptionKeyPull",{set:function(a){this._encryptionKeyPull=a},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,"encryptionKeyPush",{set:function(a){this._encryptionKeyPush=a},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,"data",{get:function(){return this._data},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,"access",{get:function(){return this._access},enumerable:!0,configurable:!0}),c.prototype.start=function(){this._provider.start(),this.updatesOn=!0},c.prototype.stop=function(){this._provider.stop(),this.updatesOn=!1},c.prototype.push=function(a,b){return void 0===b&&(b=!0),b?this.pushDelta(a):this.pushFull(a)},c.prototype.decrypt=function(a){if(a||(a=this._encryptionKeyPull),this._data.encryption_type_used&&!a.passphrase)return void(this.decrypted=!1);if(this._data.encryption_type_used){var b=h.decryptContent({name:a.name,passphrase:a.passphrase},this._data.encrypted_content);b?(this.decrypted=!0,this._data.content=b,this._encryptionKeyPull=a,this.emit(this.EVENT_DECRYPTED)):(this.decrypted=!1,this.emit(this.EVENT_ERROR,new Error('Could not decrypt page with key "'+a.name+'" and passphrase "'+a.passphrase+'"')))}else this.decrypted=!0;this.decrypted&&(this._data.content=q.decompressStyles(this._data.content))},c.prototype.destroy=function(){this._provider.destroy(),d.cancel(this._accessInterval),this.removeEvent()},c.prototype.clone=function(a,d,e){var f=this;void 0===e&&(e={});var g=b.defer();return this.ready?(e.clone_ranges&&this._folderId!==a&&(e.clone_ranges=!1),c.create(this._folderId,d,this._data.special_page_type).then(function(a){b.all([a.push(f._data.content,!1)]).then(function(b){g.resolve(a)},g.reject)},function(a){g.reject(a)}),g.promise):(g.reject("Page is not ready"),g.promise)},c.prototype.init=function(){var a=this;this.Ranges=new n(this._folderId,this._pageId),!this._supportsWS||"undefined"==typeof io,this._provider=this._supportsWS&&"undefined"!=typeof io&&"polling"!==i.transport?new p(this._pageId,this._folderId):new o(this._pageId,this._folderId),this.getPageAccess(),this._accessInterval=d(function(){a.getPageAccess()},3e4),this.registerListeners()},c.prototype.getPageId=function(a,c){var d=b.defer();return e.getPageByName({domainId:a,pageId:c}).then(function(a){d.resolve({pageId:a.data.id,folderId:a.data.domain_id})},function(a){d.reject(a)}),d.promise},c.prototype.getPageAccess=function(){var a=this,c=b.defer();return e.getPageAccess({domainId:this._folderId,pageId:this._pageId}).then(function(b){a._access=b.data,a.emit(a.EVENT_ACCESS_UPDATED),c.resolve()},function(a){c.reject()}),c.promise},c.prototype.registerListeners=function(){var a=this;this._provider.on("content_update",function(b){b.special_page_type=a.updatePageType(b.special_page_type),a._data=angular.merge({},a._data,b),a.decrypt(),a._contentLoaded=!0,a.checkReady(),a.emit(a.EVENT_NEW_CONTENT,a._data)}),this._provider.on("meta_update",function(b){b.special_page_type=a.updatePageType(b.special_page_type),delete b.content,delete b.encrypted_content,a._data=angular.merge({},a._data,b),a.Ranges.parse(b.access_rights||"[]"),a._metaLoaded=!0,a.checkReady(),a.emit(a.EVENT_NEW_META,b)}),this._provider.on("error",function(b){b.code=b.httpCode||b.code,b.message=b.httpText||b.message,a.emit(a.EVENT_ERROR,b.message),404===b.code&&a.destroy()})},c.prototype.pushFull=function(a){var c=this,d=b.defer();if(this._data.encryption_type_to_use){if(!this._encryptionKeyPull||this._data.encryption_key_to_use!==this._encryptionKeyPush.name)return d.reject("None or wrong encryption key"),d.promise;var f=this.encrypt(this._encryptionKeyPush,a);if(!f)return d.reject("Encryption failed"),d.promise;this._data.encrypted_content=f,this._data.encryption_type_used=1,this._data.encryption_key_used=this._encryptionKeyPush.name}else this._data.encryption_key_used="",this._data.encryption_type_used=0,this._data.content=a;var g={content:this._data.content,encrypted_content:this._data.encrypted_content,encryption_type_used:this._data.encryption_type_used,encryption_key_used:this._data.encryption_key_used},h={domainId:this._folderId,pageId:this._pageId,data:g};return e.savePageContent(h).then(function(a){c._data.seq_no=a.data.seq_no,d.resolve(a)},d.reject),d.promise},c.prototype.pushDelta=function(a){var c=b.defer(),d={domainId:this._folderId,pageId:this._pageId,data:a};return e.savePageContentDelta(d).then(c.resolve,c.reject),c.promise},c.prototype.checkReady=function(){this._contentLoaded&&this._metaLoaded&&!this.ready&&(this.ready=!0,this.emit(this.EVENT_READY))},c.prototype.updatePageType=function(a){return(a>0&&a<5||7===a)&&(a+=1e3),a},c.prototype.encrypt=function(a,b){return h.encryptContent(a,b)},c}(EventEmitter),l=function(){function a(a,b,c,d,e,f){void 0===b&&(b=0),void 0===c&&(c=0),void 0===d&&(d=0),void 0===e&&(e=0),this.name=a,this.rowStart=b,this.rowEnd=c,this.colStart=d,this.colEnd=e,this._permissions={ro:[],no:[]},f&&(this._permissions=f)}return a.prototype.setPermission=function(a,b){this._permissions.ro.indexOf(a)>=0&&this._permissions.ro.splice(this._permissions.ro.indexOf(a),1),this._permissions.no.indexOf(a)>=0&&this._permissions.no.splice(this._permissions.no.indexOf(a),1),b&&this._permissions[b].push(a)},a.prototype.getPermission=function(a){var b="";return this._permissions.ro.indexOf(a)>=0?b="ro":this._permissions.no.indexOf(a)>=0&&(b="no"),b},a.prototype.toObject=function(){return{name:this.name,start:this.rowStart+":"+this.colStart,end:this.rowEnd+":"+this.colEnd,rights:this._permissions,freeze:!1}},a}();a.PermissionRange=l;var m=function(){function a(a,b,c){void 0===b&&(b="rows"),void 0===c&&(c=1),this.name=a,this.subject=b,this.count=c}return Object.defineProperty(a,"SUBJECT_ROWS",{get:function(){return"rows"},enumerable:!0,configurable:!0}),Object.defineProperty(a,"SUBJECT_COLUMNS",{get:function(){return"cols"},enumerable:!0,configurable:!0}),a.prototype.toObject=function(){var b={name:this.name,start:"0:0",end:"",rights:{ro:[],no:[]},freeze:!0};return this.subject===a.SUBJECT_ROWS?b.end=this.count-1+":-1":b.end="-1:"+(this.count-1),b},a}();a.FreezingRange=m;var n=function(){function a(a,b,c){this._ranges=[],this._folderId=a,this._pageId=b,c&&this.parse(c)}return Object.defineProperty(a.prototype,"TYPE_PERMISSION_RANGE",{get:function(){return"permissions"},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"TYPE_FREEZING_RANGE",{get:function(){return"freezing"},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"ranges",{get:function(){return this._ranges},enumerable:!0,configurable:!0}),a.prototype.setRanges=function(a){return this._ranges=a,this},a.prototype.addRange=function(a){for(var b=!1,c=a.name,d=1;!b;){b=!0;for(var e=0;e<this._ranges.length;e++)this._ranges[e].name===c&&(b=!1,c=a.name+"_"+d,d++)}return a.name=c,this._ranges.push(a),this},a.prototype.removeRange=function(a){return this._ranges.indexOf(a)>=0&&this._ranges.splice(this._ranges.indexOf(a),1),this},a.prototype.save=function(){for(var a=[],b=0;b<this._ranges.length;b++)a.push(this._ranges[b].toObject());var c={domainId:this._folderId,pageId:this._pageId,data:{access_rights:JSON.stringify(a)}};return e.savePageSettings(c)},a.prototype.parse=function(a){var b=JSON.parse(a);this._ranges=[];for(var c=0;c<b.length;c++){var d=parseInt(b[c].start.split(":")[0],10),e=parseInt(b[c].end.split(":")[0],10),f=parseInt(b[c].start.split(":")[1],10),g=parseInt(b[c].end.split(":")[1],10);if(b[c].freeze){var h=g>=0?"cols":"rows",i=g>=0?g+1:e+1;this._ranges.push(new m(b[c].name,h,i))}else this._ranges.push(new l(b[c].name,d,e,f,g,b[c].rights))}return this._ranges},a}(),o=function(a){function d(b,c){a.call(this),this._pageId=b,this._folderId=c,this._stopped=!1,this._requestOngoing=!1,this._timeout=1e3,this._seqNo=0,this.start()}return __extends(d,a),d.prototype.start=function(){this._stopped=!1,this.startPolling()},d.prototype.stop=function(){this._stopped=!0,c.cancel(this._timer)},d.prototype.destroy=function(){this.stop(),this.removeEvent()},d.prototype.startPolling=function(){var a=this;this.load(),this._timer=c(function(){a.startPolling()},this._timeout)},d.prototype.load=function(a){var c=this;void 0===a&&(a=!1);var d=b.defer();return this._requestOngoing||this._stopped?(d.reject({}),d.promise):(this._requestOngoing=!0,e.getPage({domainId:this._folderId,pageId:this._pageId,seq_no:a?void 0:this._seqNo}).then(function(a){200===a.httpCode||204===a.httpCode?(200===a.httpCode?(c._seqNo=a.data.seq_no,c.emit("content_update",c.tempGetContentOb(a.data)),c.emit("meta_update",c.tempGetSettingsOb(a.data))):c.emit("empty_update"),d.resolve(a.data)):(c.emit("error",a.data),d.reject({}))},function(a){c.emit("error",a),d.reject(a)}).finally(function(){c._requestOngoing=!1}),d.promise)},d.prototype.tempGetContentOb=function(a){return{id:a.id,domain_id:a.domain_id,seq_no:a.seq_no,content_modified_timestamp:a.content_modified_timestamp,content:a.content,content_modified_by:a.content_modified_by,push_interval:a.push_interval,pull_interval:a.pull_interval,is_public:a.is_public,description:a.description,encrypted_content:a.encrypted_content,encryption_key_used:a.encryption_key_used,encryption_type_used:a.encryption_type_used,special_page_type:a.special_page_type}},d.prototype.tempGetSettingsOb=function(a){return JSON.parse(JSON.stringify(a))},d}(EventEmitter),p=function(a){function b(b,d){var e=this;a.call(this),this._pageId=b,this._folderId=d,this._stopped=!1,this.onConnect=function(){},this.onDisconnect=function(){},this.onPageContent=function(a){c(function(){e.emit("content_update",a)})},this.onPageSettings=function(a){c(function(){e.emit("meta_update",a)})},this.onPageError=function(a){c(function(){401===a.code?f.emit(f.EVENT_401):e.emit("error",a)})},this.onOAuthError=function(a){},this.onAuthRefresh=function(){
e._pageId;e.start()},this.supportsWebSockets=function(){return"WebSocket"in window||"MozWebSocket"in window},this.start(),f.on(f.EVENT_LOGIN_REFRESHED,this.onAuthRefresh)}return __extends(b,a),Object.defineProperty(b,"SOCKET_EVENT_PAGE_ERROR",{get:function(){return"page_error"},enumerable:!0,configurable:!0}),Object.defineProperty(b,"SOCKET_EVENT_PAGE_CONTENT",{get:function(){return"page_content"},enumerable:!0,configurable:!0}),Object.defineProperty(b,"SOCKET_EVENT_PAGE_PUSH",{get:function(){return"page_push"},enumerable:!0,configurable:!0}),Object.defineProperty(b,"SOCKET_EVENT_PAGE_SETTINGS",{get:function(){return"page_settings"},enumerable:!0,configurable:!0}),Object.defineProperty(b,"SOCKET_EVENT_PAGE_DATA",{get:function(){return"page_data"},enumerable:!0,configurable:!0}),Object.defineProperty(b,"SOCKET_EVENT_PAGE_USER_JOINED",{get:function(){return"page_user_joined"},enumerable:!0,configurable:!0}),Object.defineProperty(b,"SOCKET_EVENT_PAGE_USER_LEFT",{get:function(){return"page_user_left"},enumerable:!0,configurable:!0}),b.prototype.start=function(){this._socket&&this._socket.connected?this._socket.on(b.SOCKET_EVENT_PAGE_CONTENT,this.onPageContent):this.init()},b.prototype.stop=function(){this._socket.off(b.SOCKET_EVENT_PAGE_CONTENT,this.onPageContent),this._stopped=!0},b.prototype.destroy=function(){this._socket.removeAllListeners(),this._socket.disconnect(),this.stop(),f.off(f.EVENT_LOGIN_REFRESHED,this.onAuthRefresh),this.removeEvent()},b.prototype.init=function(){this._socket=this.connect(),this._socket.on("connect",this.onConnect),this._socket.on(b.SOCKET_EVENT_PAGE_CONTENT,this.onPageContent),this._socket.on(b.SOCKET_EVENT_PAGE_SETTINGS,this.onPageSettings),this._socket.on(b.SOCKET_EVENT_PAGE_ERROR,this.onPageError),this._socket.on("oauth_error",this.onOAuthError),this._socket.on("disconnect",this.onDisconnect),this._stopped=!1},b.prototype.connect=function(){var a=["access_token="+g.get("access_token")];return a=a.filter(function(a){return a.length>0}),io.connect(i.url+"/page/"+this._pageId,{query:a.join("&"),transports:this.supportsWebSockets()?["websocket"]:["polling"],forceNew:!0})},b}(EventEmitter),q=function(){function a(){this.currentStyle={},this.currentBorders={top:{},right:{},bottom:{},left:{}},this.excelStyles={"text-wrap":"white-space",tbs:"border-top-style",rbs:"border-right-style",bbs:"border-bottom-style",lbs:"border-left-style",tbc:"border-top-color",rbc:"border-right-color",bbc:"border-bottom-color",lbc:"border-left-color",tbw:"border-top-width",rbw:"border-right-width",bbw:"border-bottom-width",lbw:"border-left-width"},this.excelBorderStyles={solid:"solid",thin:"solid",thick:"solid",hair:"solid",dash:"dashed",dashed:"dashed",dashdot:"dashed",mediumdashed:"dashed",mediumdashdot:"dashed",slantdashdot:"dashed",dot:"dotted",dotted:"dotted",hairline:"dotted",mediumdashdotdot:"dotted",dashdotdot:"dotted",double:"double"},this.excelBorderWeights={thin:"1px",medium:"1px",thick:"2px",hair:"1px",hairline:"1px",double:"3px"},this.ignoreStyles=["number-format"]}return a.decompressStyles=function(b){for(var c=new a,d=0;d<b.length;d++)for(var e=0;e<b[d].length;e++)b[d][e].style=c.makeStyle(b[d][e].style);return b},a.prototype.reset=function(){this.currentStyle={},this.currentBorders={top:{},right:{},bottom:{},left:{}}},a.prototype.makeStyle=function(a){var b,c=angular.copy(a);for(var d in c)if(!(this.ignoreStyles.indexOf(d)>=0)){b=this.excelToCSS(d);var e="",f="";if("color"!==b&&"background-color"!==b||"none"===c[d]||(e="#"),"font-family"===b&&(f=", Arial, Helvetica, sans-serif"),"white-space"===b&&(c[d]="normal"===c[d]?"pre":"pre-wrap"),"width"!==b&&"height"!==b||(f=" !important"),b.indexOf("border")>=0){var g=b.split("-")[1];b.indexOf("-style")>=0&&(this.currentBorders[g].style=this.excelBorderStyles[c[d]]||void 0),b.indexOf("-width")>=0&&(this.currentBorders[g].width="none"!==c[d]?this.excelBorderWeights[c[d]]:void 0),b.indexOf("-color")>=0&&(this.currentBorders[g].color="none"===c[d]?"transparent":"#"+c[d])}else this.currentStyle[b]=e+c[d]+f}var h=angular.copy(this.currentStyle);for(var i in this.currentBorders)"undefined"!=typeof this.currentBorders[i].style&&this.currentBorders[i].style&&(h["border-"+i]=this.currentBorders[i].width+" "+this.currentBorders[i].style+" "+this.currentBorders[i].color+";");return h},a.prototype.excelToCSS=function(a){return this.excelStyles[a]?this.excelStyles[a]:a},a.prototype.CSSToExcel=function(a){var b=a;for(var c in this.excelStyles)if(this.excelStyles[c]===a){b=c;break}return b},a.prototype.excelBorderWeight=function(a){var b="";for(var c in this.excelBorderWeights)if(this.excelBorderWeights[c]===a){b=c;break}return b},a}()}(ipushpull||(ipushpull={}));var ipushpull;!function(a){"use strict";var b=function(){function a(){this.prefix="ipp"}return a.prototype.create=function(a,b){localStorage.setItem(this.makeKey(a),b)},a.prototype.save=function(a,b){return this.create(a,b)},a.prototype.get=function(a,b){void 0===b&&(b=null);var c=localStorage.getItem(this.makeKey(a));return c?this.isValidJSON(c)?JSON.parse(c):c:b},a.prototype.remove=function(a){localStorage.removeItem(this.makeKey(a))},a.prototype.makeKey=function(a){return this.prefix&&0!==a.indexOf(this.prefix)&&(a=this.prefix+"_"+a),this.suffix&&(a=a+"_"+this.suffix),a},a.prototype.isValidJSON=function(a){try{JSON.parse(a);return!0}catch(a){return!1}},a}();a.module.service("ippUserStorageService",["ippAuthService","ipushpull_conf",function(a,c){var d=new b;return d.suffix="GUEST",c.storage_prefix&&(d.prefix=c.storage_prefix),a.on("logged_in",function(){d.suffix=""+a.user.id}),d}]),a.module.service("ippGlobalStorageService",["ipushpull_conf",function(a){var c=new b;return a.storage_prefix&&(c.prefix=a.storage_prefix),c}])}(ipushpull||(ipushpull={}));